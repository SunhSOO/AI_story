# 동화책 API 백엔드 구현 계획

## 목표

External API Specification v2.0을 따르는 FastAPI 백엔드 서버 구현. 이 서버는 다음을 제공합니다:
- 시대, 장소, 등장인물, 주제 입력을 위한 필드별 STT(음성-텍스트 변환)
- 비동기 동화 생성 파이프라인: LLM → 이미지 생성 (ComfyUI) → TTS
- 실시간 업데이트를 위한 SSE 이벤트 스트리밍
- 생성된 이미지 및 오디오 파일 다운로드

이를 통해 프론트엔드(범위 외)에서 사용자 입력을 수집하고 동화책 생성 진행상황을 모니터링할 수 있습니다.

## 사용자 확인 필요 사항

> [!IMPORTANT]
> **FastAPI 및 Uvicorn 설치**
> 현재 requirements.txt에 `fastapi` 또는 `uvicorn`이 포함되어 있지 않습니다. 서버 활성화를 위해 이러한 종속성을 추가합니다.

> [!IMPORTANT]  
> **STT 라이브러리 선택**
> 음성 인식을 위해 `openai-whisper`(로컬 추론)를 사용합니다. 신뢰할 수 있고 한국어를 포함한 여러 언어를 지원하며 "로컬 우선" 원칙에 부합합니다. requirements.txt에 `openai-whisper`를 추가해야 합니다.

> [!IMPORTANT]
> **ComfyUI 통합 방식**
> ComfyUI 통합은 HTTP POST API(`/prompt`)를 사용합니다. 서버는:
> - ComfyUI가 이미 실행 중이 아니면 별도 프로세스로 시작
> - 각 패널에 대해 `make_panel.json` 워크플로우를 동적으로 수정
> - 첫 번째 패널(표지)에 랜덤 시드 사용, 이후 패널 1-4는 동일한 시드 재사용
> - 완료를 위해 폴링하고 생성된 이미지 다운로드

> [!WARNING]
> **출력 자동 삭제 정책**
> 사양에서는 출력이 100개 실행을 초과할 때 자동 삭제가 필요합니다. 이는 오래된 사용자 동화책이 영구적으로 삭제됨을 의미합니다. 이것이 허용 가능한가요?

## 제안 변경사항

### 핵심 서버 인프라

#### [신규] [server.py](file:///c:/Users/user/Desktop/make_story/server.py)

6개의 필수 엔드포인트를 구현하는 메인 FastAPI 애플리케이션:
- `POST /api/stt/field` - 신뢰도 점수를 포함한 필드 STT
- `POST /api/runs` - 실행 생성 및 `run_id` 반환
- `GET /api/runs/{run_id}` - 실행 상태 조회
- `GET /api/runs/{run_id}/events` - SSE 이벤트 스트림
- `GET /api/runs/{run_id}/images/{filename}` - 이미지 다운로드
- `GET /api/runs/{run_id}/audio/{filename}` - 오디오 다운로드

CORS 미들웨어, 백그라운드 작업 관리, 실행 상태 추적을 포함합니다.

---

### 파이프라인 컴포넌트

#### [신규] [pipeline/\_\_init\_\_.py](file:///c:/Users/user/Desktop/make_story/pipeline/__init__.py)

파이프라인 모듈 초기화.

#### [신규] [pipeline/stt.py](file:///c:/Users/user/Desktop/make_story/pipeline/stt.py)

Whisper를 사용한 STT 구현:
- 오디오 파일 전사
- 필드 유형별 파싱 (시대/장소/등장인물/주제 정규화)
- 신뢰도 점수 계산
- 언어 지원 (기본값: ko-KR)

#### [신규] [pipeline/story_pipeline.py](file:///c:/Users/user/Desktop/make_story/pipeline/story_pipeline.py)

비동기 동화 생성 오케스트레이터:
- 기존 `run_story.py` LLM 로직 통합
- 표지 + 4개 패널에 대한 이미지 생성 호출
- 각 페이지에 대한 TTS 생성 호출
- 각 단계에서 실행 상태 업데이트
- SSE 이벤트 발생

#### [신규] [pipeline/image_gen.py](file:///c:/Users/user/Desktop/make_story/pipeline/image_gen.py)

ComfyUI 통합:
- `make_panel.json` 워크플로우 로드 및 수정
- 표지(첫 패널)용 랜덤 시드 생성
- 패널 1-4용 시드 재사용
- 긍정 프롬프트 앞에 "watercolor painting, children's book illustration" 추가
- `make_panel.json`의 부정 프롬프트 그대로 사용
- ComfyUI HTTP API를 통해 워크플로우 제출
- 완료 폴링 및 이미지 조회

#### [신규] [pipeline/tts_gen.py](file:///c:/Users/user/Desktop/make_story/pipeline/tts_gen.py)

TTS 생성 래퍼:
- 기존 `run_tts.py` 로직 통합
- M1 음성, 한국어 사용
- 패널별 오디오 생성 (page_0.wav ... page_4.wav)

---

### 상태 관리

#### [신규] [models.py](file:///c:/Users/user/Desktop/make_story/models.py)

API 계약을 위한 Pydantic 모델:
- `FieldSTTRequest` / `FieldSTTResponse`
- `CreateRunRequest` / `CreateRunResponse`
- `RunStateResponse`, `PageInfo`
- `Status` 및 `Stage` 열거형

#### [신규] [run_manager.py](file:///c:/Users/user/Desktop/make_story/run_manager.py)

실행 상태 관리:
- 인메모리 실행 상태 저장소
- `ready_max_page` / `ready_max_audio_page` 추적
- 출력 디렉토리 관리 (`outputs/{run_id}/`)
- 가장 오래된 실행 자동 삭제 (최근 100개 유지)
- 실행별 SSE 이벤트 큐

---

### 설정

#### [수정] [requirements.txt](file:///c:/Users/user/Desktop/make_story/requirements.txt)

새 종속성 추가:
- `fastapi>=0.115.0`
- `uvicorn[standard]>=0.32.0`
- `openai-whisper>=20231117`
- `python-multipart>=0.0.9` (파일 업로드용)
- `sse-starlette>=2.0.0` (SSE용)

---

### 유틸리티

#### [신규] [utils/comfyui_launcher.py](file:///c:/Users/user/Desktop/make_story/utils/comfyui_launcher.py)

ComfyUI 프로세스 관리:
- ComfyUI 실행 여부 확인
- 필요시 ComfyUI 서버 시작
- 헬스 체크 엔드포인트 폴링

#### [신규] [utils/output_cleaner.py](file:///c:/Users/user/Desktop/make_story/utils/output_cleaner.py)

출력 디렉토리 정리:
- 총 출력 수 카운트
- 개수가 100을 초과하면 가장 오래된 것 삭제

## 검증 계획

### 자동화 테스트

#### 1. STT 엔드포인트 테스트
**명령어:**
```powershell
venv\Scripts\activate
python -m pytest tests/test_stt.py -v
```

**테스트 항목:**
- `POST /api/stt/field`가 멀티파트 오디오 파일 수락
- `stt_text`, `parsed_value`, `confidence` 반환
- 필드 유형별 파싱 작동

#### 2. 실행 생성 테스트
**명령어:**
```powershell
python -m pytest tests/test_runs.py::test_create_run -v
```

**테스트 항목:**
- `POST /api/runs`가 201과 `run_id` 반환
- 백그라운드 작업 시작
- 상태가 QUEUED → RUNNING으로 진행

#### 3. 상태 조회 테스트
**명령어:**
```powershell
python -m pytest tests/test_runs.py::test_query_state -v
```

**테스트 항목:**
- `GET /api/runs/{run_id}`가 유효한 `RunStateResponse` 반환
- `status`, `stage`, `ready_max_page`, `ready_max_audio_page` 필드 존재
- `pages` 배열이 5개 요소 포함 (0-4)

### 수동 검증

#### 1. 서버 시작
서버 시작:
```powershell
cd c:\Users\user\Desktop\make_story
venv\Scripts\activate
uvicorn server:app --host 127.0.0.1 --port 8000 --reload
```

예상 결과: 오류 없이 서버 시작, http://127.0.0.1:8000 에서 접근 가능

#### 2. 엔드투엔드 동화 생성
curl 또는 Postman을 사용하여 실행 생성:
```powershell
curl -X POST http://127.0.0.1:8000/api/runs `
  -H "Content-Type: application/json" `
  -d '{\"era_ko\":\"현대\",\"place_ko\":\"숲\",\"characters_ko\":\"토끼\",\"topic_ko\":\"우정\"}'
```

예상 결과:
- `{"run_id": "..."}` 반환
- SSE 이벤트가 진행상황 스트리밍
- 이미지가 `outputs/{run_id}/`에 나타남
- 오디오 파일이 `outputs/{run_id}/`에 나타남
- 상태가 DONE에 도달

#### 3. SSE 이벤트 스트림
브라우저 또는 curl로 SSE 스트림 열기:
```powershell
curl http://127.0.0.1:8000/api/runs/{run_id}/events
```

예상 결과:
- 파이프라인 진행에 따라 이벤트 스트리밍
- `ready_max_page`가 -1에서 4로 증가
- `ready_max_audio_page`가 -1에서 4로 증가

#### 4. 파일 다운로드
생성된 파일 다운로드:
```powershell
curl http://127.0.0.1:8000/api/runs/{run_id}/images/cover.png -o cover.png
curl http://127.0.0.1:8000/api/runs/{run_id}/audio/page_0.wav -o page_0.wav
```

예상 결과:
- PNG 이미지가 올바르게 표시됨
- WAV 오디오가 올바르게 재생됨

#### 5. 자동 삭제 테스트
101개의 실행 생성 및 검증:
```powershell
# 101개 실행을 생성하는 스크립트
for ($i=1; $i -le 101; $i++) {
  curl -X POST http://127.0.0.1:8000/api/runs -H "Content-Type: application/json" -d '{\"era_ko\":\"현대\",\"place_ko\":\"숲\",\"characters_ko\":\"토끼$i\",\"topic_ko\":\"우정\"}'
}
```

예상 결과:
- 최근 100개의 출력 디렉토리만 남음
- 가장 오래된 디렉토리가 자동으로 삭제됨
