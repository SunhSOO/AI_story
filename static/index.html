<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ë™í™”ì±… ìƒì„±ê¸°</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        h1 {
            text-align: center;
            color: #667eea;
            margin-bottom: 30px;
            font-size: 28px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
        }

        .input-wrapper {
            position: relative;
        }

        .input-with-mic {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .mic-button {
            flex-shrink: 0;
            width: 45px;
            height: 45px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .mic-button:hover {
            transform: scale(1.1);
        }

        .mic-button.recording {
            background: #e74c3c;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.05);
            }
        }

        .stt-status {
            font-size: 12px;
            color: #667eea;
            margin-top: 5px;
        }

        input,
        select {
            flex: 1;
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input:focus,
        select:focus {
            outline: none;
            border-color: #667eea;
        }

        button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .status {
            margin-top: 30px;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 10px;
            display: none;
        }

        .status.show {
            display: block;
        }

        .status h3 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.5s;
        }

        .results {
            margin-top: 20px;
            display: none;
        }

        .results.show {
            display: block;
        }

        .result-item {
            margin: 10px 0;
            padding: 10px;
            background: white;
            border-radius: 8px;
        }

        .result-item img {
            width: 100%;
            border-radius: 8px;
            margin-top: 10px;
        }

        .audio-player {
            width: 100%;
            margin-top: 10px;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>ğŸ¨ AI ë™í™”ì±… ìƒì„±ê¸°</h1>

        <div class="input-group">
            <label for="era">ì‹œëŒ€ ğŸ™ï¸</label>
            <div class="input-with-mic">
                <input type="text" id="era" placeholder="ì˜ˆ: í˜„ëŒ€, ì˜›ë‚ ">
                <button class="mic-button" onclick="startSTT('era')" title="ìŒì„± ì…ë ¥">ğŸ¤</button>
            </div>
            <div id="era-status" class="stt-status"></div>
        </div>

        <div class="input-group">
            <label for="place">ì¥ì†Œ ğŸ™ï¸</label>
            <div class="input-with-mic">
                <input type="text" id="place" placeholder="ì˜ˆ: ìˆ², ë°”ë‹¤">
                <button class="mic-button" onclick="startSTT('place')" title="ìŒì„± ì…ë ¥">ğŸ¤</button>
            </div>
            <div id="place-status" class="stt-status"></div>
        </div>

        <div class="input-group">
            <label for="characters">ë“±ì¥ì¸ë¬¼ ğŸ™ï¸</label>
            <div class="input-with-mic">
                <input type="text" id="characters" placeholder="ì˜ˆ: í† ë¼, ì—¬ìš°">
                <button class="mic-button" onclick="startSTT('characters')" title="ìŒì„± ì…ë ¥">ğŸ¤</button>
            </div>
            <div id="characters-status" class="stt-status"></div>
        </div>

        <div class="input-group">
            <label for="topic">ì£¼ì œ ğŸ™ï¸</label>
            <div class="input-with-mic">
                <input type="text" id="topic" placeholder="ì˜ˆ: ìš°ì •, ìš©ê¸°">
                <button class="mic-button" onclick="startSTT('topic')" title="ìŒì„± ì…ë ¥">ğŸ¤</button>
            </div>
            <div id="topic-status" class="stt-status"></div>
        </div>

        <div class="input-group">
            <label for="tts">ìŒì„± ìƒì„±</label>
            <select id="tts">
                <option value="true">ìƒì„±</option>
                <option value="false">ìƒì„± ì•ˆí•¨</option>
            </select>
        </div>

        <button id="generateBtn" onclick="generateStory()">ë™í™” ìƒì„±í•˜ê¸°</button>

        <div class="status" id="status">
            <h3>ìƒì„± ì¤‘...</h3>
            <div id="statusText">ì¤€ë¹„ ì¤‘</div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressBar"></div>
            </div>
            <div id="stageInfo"></div>
        </div>

        <div class="results" id="results">
            <h3>ìƒì„± ì™„ë£Œ!</h3>
            <div id="resultContent"></div>
        </div>
    </div>

    <script>
        // API ì„œë²„ URL (íœ´ëŒ€í°ì—ì„œ ì ‘ì†í•  ë•ŒëŠ” PCì˜ IP ì£¼ì†Œë¡œ ë³€ê²½)
        const API_URL = window.location.origin;

        let currentRunId = null;
        let eventSource = null;
        let mediaRecorder = null;
        let audioChunks = [];

        // STT ê¸°ëŠ¥
        async function startSTT(fieldType) {
            const button = event.target;
            const statusDiv = document.getElementById(`${fieldType}-status`);

            try {
                // ë¸Œë¼ìš°ì € ì§€ì› í™•ì¸
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    throw new Error('ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„± ë…¹ìŒì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤');
                }

                // ë§ˆì´í¬ ê¶Œí•œ ìš”ì²­
                const stream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        sampleRate: 16000  // Whisper ìµœì í™”
                    }
                });

                // ë…¹ìŒ ì‹œì‘
                audioChunks = [];

                // ëª¨ë°”ì¼ í˜¸í™˜ì„±ì„ ìœ„í•œ MIME íƒ€ì… í™•ì¸
                let mimeType = 'audio/webm';
                if (!MediaRecorder.isTypeSupported('audio/webm')) {
                    if (MediaRecorder.isTypeSupported('audio/mp4')) {
                        mimeType = 'audio/mp4';
                    } else if (MediaRecorder.isTypeSupported('audio/mpeg')) {
                        mimeType = 'audio/mpeg';
                    } else if (MediaRecorder.isTypeSupported('audio/wav')) {
                        mimeType = 'audio/wav';
                    }
                }

                mediaRecorder = new MediaRecorder(stream, { mimeType });

                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        audioChunks.push(event.data);
                    }
                };

                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: mimeType });
                    await sendSTT(audioBlob, fieldType, mimeType);
                    stream.getTracks().forEach(track => track.stop());
                };

                button.classList.add('recording');
                statusDiv.textContent = 'ğŸ¤ ë…¹ìŒ ì¤‘... (í´ë¦­í•˜ë©´ ì¢…ë£Œ)';

                mediaRecorder.start();

                // ë²„íŠ¼ ë‹¤ì‹œ í´ë¦­í•˜ë©´ ì¤‘ì§€
                button.onclick = () => {
                    if (mediaRecorder && mediaRecorder.state === 'recording') {
                        mediaRecorder.stop();
                        button.classList.remove('recording');
                        statusDiv.textContent = 'ì²˜ë¦¬ ì¤‘...';
                        button.onclick = () => startSTT(fieldType);
                    }
                };

            } catch (error) {
                console.error('STT ì˜¤ë¥˜:', error);
                let errorMsg = 'ë§ˆì´í¬ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤';
                if (error.name === 'NotAllowedError') {
                    errorMsg = 'ë§ˆì´í¬ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”';
                } else if (error.name === 'NotFoundError') {
                    errorMsg = 'ë§ˆì´í¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤';
                }
                alert(errorMsg + ': ' + error.message);
                statusDiv.textContent = '';
            }
        }

        async function sendSTT(audioBlob, fieldType, mimeType) {
            const statusDiv = document.getElementById(`${fieldType}-status`);

            try {
                // íŒŒì¼ í™•ì¥ì ê²°ì •
                let extension = 'webm';
                if (mimeType.includes('mp4')) extension = 'mp4';
                else if (mimeType.includes('mpeg')) extension = 'mp3';
                else if (mimeType.includes('wav')) extension = 'wav';

                const formData = new FormData();
                formData.append('audio_file', audioBlob, `recording.${extension}`);
                formData.append('field_type', fieldType);

                statusDiv.textContent = 'ğŸ”„ ì„œë²„ë¡œ ì „ì†¡ ì¤‘...';

                const response = await fetch(`${API_URL}/api/stt/field`, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`STT ìš”ì²­ ì‹¤íŒ¨: ${response.status} - ${errorText}`);
                }

                const data = await response.json();

                // ì…ë ¥ í•„ë“œì— ê²°ê³¼ ì…ë ¥
                const resultText = data.parsed_value || data.stt_text;
                if (resultText) {
                    document.getElementById(fieldType).value = resultText;
                    statusDiv.textContent = `âœ“ ì¸ì‹ë¨ (${Math.round(data.confidence * 100)}%)`;
                } else {
                    statusDiv.textContent = 'âœ— ìŒì„±ì„ ì¸ì‹í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤';
                }

                setTimeout(() => {
                    statusDiv.textContent = '';
                }, 3000);

            } catch (error) {
                console.error('sendSTT ì˜¤ë¥˜:', error);
                statusDiv.textContent = 'âœ— ì¸ì‹ ì‹¤íŒ¨';
                alert('STT ì˜¤ë¥˜: ' + error.message);
            }
        }

        async function generateStory() {
            const era = document.getElementById('era').value;
            const place = document.getElementById('place').value;
            const characters = document.getElementById('characters').value;
            const topic = document.getElementById('topic').value;
            const ttsEnabled = document.getElementById('tts').value === 'true';

            if (!era || !place || !characters || !topic) {
                alert('ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!');
                return;
            }

            // UI ì´ˆê¸°í™”
            document.getElementById('generateBtn').disabled = true;
            document.getElementById('status').classList.add('show');
            document.getElementById('results').classList.remove('show');
            document.getElementById('progressBar').style.width = '0%';

            try {
                // 1. ë™í™” ìƒì„± ì‹œì‘
                const response = await fetch(`${API_URL}/api/runs`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        era_ko: era,
                        place_ko: place,
                        characters_ko: characters,
                        topic_ko: topic,
                        tts_enabled: ttsEnabled
                    })
                });

                if (!response.ok) {
                    throw new Error('ìƒì„± ìš”ì²­ ì‹¤íŒ¨');
                }

                const data = await response.json();
                currentRunId = data.run_id;

                // 2. SSEë¡œ ì§„í–‰ìƒí™© ëª¨ë‹ˆí„°ë§
                monitorProgress(currentRunId);

            } catch (error) {
                alert('ì˜¤ë¥˜ ë°œìƒ: ' + error.message);
                document.getElementById('generateBtn').disabled = false;
                document.getElementById('status').classList.remove('show');
            }
        }

        function monitorProgress(runId) {
            // SSE ì—°ê²°
            eventSource = new EventSource(`${API_URL}/api/runs/${runId}/events`);

            eventSource.addEventListener('update', (event) => {
                const data = JSON.parse(event.data);
                updateProgress(data);

                // ì™„ë£Œë˜ë©´ ê²°ê³¼ í‘œì‹œ
                if (data.status === 'DONE') {
                    eventSource.close();
                    showResults(runId);
                } else if (data.status === 'FAILED') {
                    eventSource.close();
                    alert('ìƒì„± ì‹¤íŒ¨: ' + (data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                    document.getElementById('generateBtn').disabled = false;
                    document.getElementById('status').classList.remove('show');
                }
            });

            eventSource.onerror = (error) => {
                console.error('SSE error:', error);
            };
        }

        function updateProgress(data) {
            const statusText = document.getElementById('statusText');
            const stageInfo = document.getElementById('stageInfo');
            const progressBar = document.getElementById('progressBar');

            // ìƒíƒœ í‘œì‹œ
            statusText.textContent = `ìƒíƒœ: ${data.status} / ë‹¨ê³„: ${data.stage}`;

            // ì§„í–‰ë¥  ê³„ì‚°
            let progress = 0;
            if (data.stage === 'LLM') progress = 20;
            else if (data.stage === 'COVER') progress = 30;
            else if (data.stage === 'PANEL_1') progress = 45;
            else if (data.stage === 'PANEL_2') progress = 60;
            else if (data.stage === 'PANEL_3') progress = 75;
            else if (data.stage === 'PANEL_4') progress = 85;
            else if (data.stage === 'TTS') progress = 95;

            progressBar.style.width = progress + '%';

            // ìƒì„¸ ì •ë³´
            stageInfo.innerHTML = `
                ì´ë¯¸ì§€: ${data.ready_max_page + 1}/5 ì™„ë£Œ<br>
                ì˜¤ë””ì˜¤: ${data.ready_max_audio_page + 1}/5 ì™„ë£Œ
            `;
        }

        async function showResults(runId) {
            document.getElementById('generateBtn').disabled = false;
            document.getElementById('status').classList.remove('show');
            document.getElementById('results').classList.add('show');
            document.getElementById('progressBar').style.width = '100%';

            // ìƒíƒœ ì¡°íšŒ
            const response = await fetch(`${API_URL}/api/runs/${runId}`);
            const data = await response.json();

            // ê²°ê³¼ í‘œì‹œ
            const resultContent = document.getElementById('resultContent');
            resultContent.innerHTML = '';

            for (const page of data.pages) {
                const div = document.createElement('div');
                div.className = 'result-item';

                let html = `<h4>Page ${page.page}</h4>`;
                if (page.title) html += `<p><strong>${page.title}</strong></p>`;
                if (page.summary) html += `<p>${page.summary}</p>`;

                if (page.image_url) {
                    html += `<img src="${API_URL}${page.image_url}" alt="Page ${page.page}">`;
                }

                if (page.audio_url) {
                    html += `<audio controls class="audio-player">
                        <source src="${API_URL}${page.audio_url}" type="audio/wav">
                    </audio>`;
                }

                div.innerHTML = html;
                resultContent.appendChild(div);
            }
        }
    </script>
</body>

</html>