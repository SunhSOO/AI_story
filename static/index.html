<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ë™í™”ì±… ìƒì„± í…ŒìŠ¤íŠ¸ ì„œë²„</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            min-height: 500px;
        }

        h1 {
            text-align: center;
            color: #667eea;
            margin-bottom: 30px;
            font-size: 28px;
        }

        /* Screen System */
        .screen {
            display: none;
            animation: fadeIn 0.4s ease-in;
        }

        .screen.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Progress Indicator */
        .progress-indicator {
            text-align: center;
            margin-bottom: 20px;
            color: #667eea;
            font-size: 14px;
            font-weight: 600;
        }

        /* Input Screens */
        .input-group {
            margin-bottom: 30px;
        }

        label {
            display: block;
            margin-bottom: 12px;
            color: #333;
            font-weight: 600;
            font-size: 18px;
        }

        .input-with-mic {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        input {
            flex: 1;
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input:focus {
            outline: none;
            border-color: #667eea;
        }

        .mic-button {
            flex-shrink: 0;
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 22px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .mic-button:hover {
            transform: scale(1.1);
        }

        .mic-button.recording {
            background: #e74c3c;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.05);
            }
        }

        .stt-status {
            font-size: 12px;
            color: #667eea;
            margin-top: 8px;
        }

        /* Buttons */
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 30px;
        }

        button.primary-btn {
            flex: 1;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        button.primary-btn:hover {
            transform: translateY(-2px);
        }

        button.primary-btn:active {
            transform: translateY(0);
        }

        button.primary-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        button.secondary-btn {
            padding: 15px 30px;
            background: #e0e0e0;
            color: #333;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.2s;
        }

        button.secondary-btn:hover {
            background: #d0d0d0;
        }

        /* Story Page Display */
        .story-page {
            text-align: center;
        }

        .loading-state {
            text-align: center;
            padding: 40px 20px;
            color: #667eea;
        }

        .loading-spinner {
            border: 4px solid #e0e0e0;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .page-content {
            display: none;
        }

        .page-content.ready {
            display: block;
        }

        .page-title {
            font-size: 24px;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
        }

        .page-summary {
            font-size: 16px;
            line-height: 1.6;
            color: #666;
            margin-bottom: 20px;
            padding: 0 10px;
        }

        .page-image {
            width: 100%;
            max-width: 500px;
            border-radius: 15px;
            margin: 20px auto;
            display: block;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .audio-player {
            width: 100%;
            margin: 20px 0;
        }

        .page-number {
            color: #667eea;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 10px;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>ğŸ¨ AI ë™í™”ì±… ìƒì„±ê¸°</h1>

        <!-- Screen 1: Era Input -->
        <div class="screen active" id="screen-era">
            <div class="progress-indicator">1 / 4</div>
            <div class="input-group">
                <label for="era">ì‹œëŒ€ë¥¼ ë§ì”€í•´ì£¼ì„¸ìš” ğŸ™ï¸</label>
                <div class="input-with-mic">
                    <input type="text" id="era" placeholder="ì˜ˆ: í˜„ëŒ€, ì˜›ë‚ , ë¯¸ë˜">
                    <button class="mic-button" onclick="startSTT('era')" title="ìŒì„± ì…ë ¥">ğŸ¤</button>
                </div>
                <div id="era-status" class="stt-status"></div>
            </div>
            <div class="button-group">
                <button class="primary-btn" onclick="nextScreen()">ë‹¤ìŒ</button>
            </div>
        </div>

        <!-- Screen 2: Place Input -->
        <div class="screen" id="screen-place">
            <div class="progress-indicator">2 / 4</div>
            <div class="input-group">
                <label for="place">ë°°ê²½ì„ ë§ì”€í•´ì£¼ì„¸ìš” ğŸ™ï¸</label>
                <div class="input-with-mic">
                    <input type="text" id="place" placeholder="ì˜ˆ: ìˆ², ë°”ë‹¤, ìš°ì£¼">
                    <button class="mic-button" onclick="startSTT('place')" title="ìŒì„± ì…ë ¥">ğŸ¤</button>
                </div>
                <div id="place-status" class="stt-status"></div>
            </div>
            <div class="button-group">
                <button class="secondary-btn" onclick="prevScreen()">ì´ì „</button>
                <button class="primary-btn" onclick="nextScreen()">ë‹¤ìŒ</button>
            </div>
        </div>

        <!-- Screen 3: Characters Input -->
        <div class="screen" id="screen-characters">
            <div class="progress-indicator">3 / 4</div>
            <div class="input-group">
                <label for="characters">ë“±ì¥ì¸ë¬¼ì„ ë§ì”€í•´ì£¼ì„¸ìš” ğŸ™ï¸</label>
                <div class="input-with-mic">
                    <input type="text" id="characters" placeholder="ì˜ˆ: í† ë¼, ì—¬ìš°, ê³°">
                    <button class="mic-button" onclick="startSTT('characters')" title="ìŒì„± ì…ë ¥">ğŸ¤</button>
                </div>
                <div id="characters-status" class="stt-status"></div>
            </div>
            <div class="button-group">
                <button class="secondary-btn" onclick="prevScreen()">ì´ì „</button>
                <button class="primary-btn" onclick="nextScreen()">ë‹¤ìŒ</button>
            </div>
        </div>

        <!-- Screen 4: Topic Input -->
        <div class="screen" id="screen-topic">
            <div class="progress-indicator">4 / 4</div>
            <div class="input-group">
                <label for="topic">ì£¼ì œë¥¼ ë§ì”€í•´ì£¼ì„¸ìš” ğŸ™ï¸</label>
                <div class="input-with-mic">
                    <input type="text" id="topic" placeholder="ì˜ˆ: ìš°ì •, ìš©ê¸°, ì‚¬ë‘">
                    <button class="mic-button" onclick="startSTT('topic')" title="ìŒì„± ì…ë ¥">ğŸ¤</button>
                </div>
                <div id="topic-status" class="stt-status"></div>
            </div>
            <div class="button-group">
                <button class="secondary-btn" onclick="prevScreen()">ì´ì „</button>
                <button class="primary-btn" onclick="startGeneration()">ë™í™” ìƒì„± ì‹œì‘!</button>
            </div>
        </div>

        <!-- Story Pages (0-4) -->
        <div class="screen" id="screen-story-0">
            <div class="page-number">í‘œì§€</div>
            <div class="story-page">
                <div class="loading-state">
                    <div class="loading-spinner"></div>
                    <p>í‘œì§€ë¥¼ ê·¸ë¦¬ëŠ” ì¤‘...</p>
                </div>
                <div class="page-content" id="page-content-0">
                    <h2 class="page-title" id="title-0"></h2>
                    <img class="page-image" id="image-0" alt="í‘œì§€">
                    <audio class="audio-player" id="audio-0" controls></audio>
                </div>
            </div>
            <div class="button-group">
                <button class="primary-btn" id="next-btn-0" onclick="nextStoryPage()" disabled>ë‹¤ìŒ í˜ì´ì§€</button>
            </div>
        </div>

        <div class="screen" id="screen-story-1">
            <div class="page-number">1 / 4</div>
            <div class="story-page">
                <div class="loading-state">
                    <div class="loading-spinner"></div>
                    <p>ì²« ë²ˆì§¸ ì¥ë©´ì„ ê·¸ë¦¬ëŠ” ì¤‘...</p>
                </div>
                <div class="page-content" id="page-content-1">
                    <p class="page-summary" id="summary-1"></p>
                    <img class="page-image" id="image-1" alt="1í˜ì´ì§€">
                    <audio class="audio-player" id="audio-1" controls></audio>
                </div>
            </div>
            <div class="button-group">
                <button class="secondary-btn" onclick="prevStoryPage()">ì´ì „ í˜ì´ì§€</button>
                <button class="primary-btn" id="next-btn-1" onclick="nextStoryPage()" disabled>ë‹¤ìŒ í˜ì´ì§€</button>
            </div>
        </div>

        <div class="screen" id="screen-story-2">
            <div class="page-number">2 / 4</div>
            <div class="story-page">
                <div class="loading-state">
                    <div class="loading-spinner"></div>
                    <p>ë‘ ë²ˆì§¸ ì¥ë©´ì„ ê·¸ë¦¬ëŠ” ì¤‘...</p>
                </div>
                <div class="page-content" id="page-content-2">
                    <p class="page-summary" id="summary-2"></p>
                    <img class="page-image" id="image-2" alt="2í˜ì´ì§€">
                    <audio class="audio-player" id="audio-2" controls></audio>
                </div>
            </div>
            <div class="button-group">
                <button class="secondary-btn" onclick="prevStoryPage()">ì´ì „ í˜ì´ì§€</button>
                <button class="primary-btn" id="next-btn-2" onclick="nextStoryPage()" disabled>ë‹¤ìŒ í˜ì´ì§€</button>
            </div>
        </div>

        <div class="screen" id="screen-story-3">
            <div class="page-number">3 / 4</div>
            <div class="story-page">
                <div class="loading-state">
                    <div class="loading-spinner"></div>
                    <p>ì„¸ ë²ˆì§¸ ì¥ë©´ì„ ê·¸ë¦¬ëŠ” ì¤‘...</p>
                </div>
                <div class="page-content" id="page-content-3">
                    <p class="page-summary" id="summary-3"></p>
                    <img class="page-image" id="image-3" alt="3í˜ì´ì§€">
                    <audio class="audio-player" id="audio-3" controls></audio>
                </div>
            </div>
            <div class="button-group">
                <button class="secondary-btn" onclick="prevStoryPage()">ì´ì „ í˜ì´ì§€</button>
                <button class="primary-btn" id="next-btn-3" onclick="nextStoryPage()" disabled>ë‹¤ìŒ í˜ì´ì§€</button>
            </div>
        </div>

        <div class="screen" id="screen-story-4">
            <div class="page-number">4 / 4 (ë§ˆì§€ë§‰)</div>
            <div class="story-page">
                <div class="loading-state">
                    <div class="loading-spinner"></div>
                    <p>ë§ˆì§€ë§‰ ì¥ë©´ì„ ê·¸ë¦¬ëŠ” ì¤‘...</p>
                </div>
                <div class="page-content" id="page-content-4">
                    <p class="page-summary" id="summary-4"></p>
                    <img class="page-image" id="image-4" alt="4í˜ì´ì§€">
                    <audio class="audio-player" id="audio-4" controls></audio>
                </div>
            </div>
            <div class="button-group">
                <button class="secondary-btn" onclick="prevStoryPage()">ì´ì „ í˜ì´ì§€</button>
                <button class="primary-btn" onclick="resetToStart()">ëë‚´ê¸°</button>
            </div>
        </div>
    </div>

    <script>
        const API_URL = window.location.origin;

        // State management
        let currentScreenIndex = 0;
        const inputScreens = ['screen-era', 'screen-place', 'screen-characters', 'screen-topic'];
        const storyScreens = ['screen-story-0', 'screen-story-1', 'screen-story-2', 'screen-story-3', 'screen-story-4'];
        let currentStoryPage = 0;
        let currentRunId = null;
        let eventSource = null;
        let mediaRecorder = null;
        let audioChunks = [];
        let ttsEnabled = true;

        // Page ready tracking
        let pageReadyStatus = [false, false, false, false, false];

        // Screen navigation
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }

        function nextScreen() {
            const currentField = ['era', 'place', 'characters', 'topic'][currentScreenIndex];
            const value = document.getElementById(currentField).value.trim();

            if (!value) {
                alert('ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!');
                return;
            }

            if (currentScreenIndex < inputScreens.length - 1) {
                currentScreenIndex++;
                showScreen(inputScreens[currentScreenIndex]);
            }
        }

        function prevScreen() {
            if (currentScreenIndex > 0) {
                currentScreenIndex--;
                showScreen(inputScreens[currentScreenIndex]);
            }
        }

        function nextStoryPage() {
            if (currentStoryPage < 4) {
                currentStoryPage++;
                showScreen(storyScreens[currentStoryPage]);
            }
        }

        function prevStoryPage() {
            if (currentStoryPage > 0) {
                currentStoryPage--;
                showScreen(storyScreens[currentStoryPage]);
            }
        }

        function resetToStart() {
            // Reset all state
            currentScreenIndex = 0;
            currentStoryPage = 0;
            currentRunId = null;
            pageReadyStatus = [false, false, false, false, false];

            // Clear inputs
            ['era', 'place', 'characters', 'topic'].forEach(field => {
                document.getElementById(field).value = '';
            });

            // Reset page content visibility
            for (let i = 0; i < 5; i++) {
                document.getElementById(`page-content-${i}`).classList.remove('ready');
                document.getElementById(`next-btn-${i}`)?.setAttribute('disabled', 'true');
            }

            if (eventSource) {
                eventSource.close();
            }

            showScreen('screen-era');
        }

        // STT functionality
        async function startSTT(fieldType) {
            const button = event.target;
            const statusDiv = document.getElementById(`${fieldType}-status`);

            try {
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    throw new Error('ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„± ë…¹ìŒì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤');
                }

                const stream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        sampleRate: 16000
                    }
                });

                audioChunks = [];
                let mimeType = 'audio/webm';
                if (!MediaRecorder.isTypeSupported('audio/webm')) {
                    if (MediaRecorder.isTypeSupported('audio/mp4')) mimeType = 'audio/mp4';
                    else if (MediaRecorder.isTypeSupported('audio/mpeg')) mimeType = 'audio/mpeg';
                    else if (MediaRecorder.isTypeSupported('audio/wav')) mimeType = 'audio/wav';
                }

                mediaRecorder = new MediaRecorder(stream, { mimeType });

                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) audioChunks.push(event.data);
                };

                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: mimeType });
                    await sendSTT(audioBlob, fieldType, mimeType);
                    stream.getTracks().forEach(track => track.stop());
                };

                button.classList.add('recording');
                statusDiv.textContent = 'ğŸ¤ ë…¹ìŒ ì¤‘... (í´ë¦­í•˜ë©´ ì¢…ë£Œ)';
                mediaRecorder.start();

                button.onclick = () => {
                    if (mediaRecorder && mediaRecorder.state === 'recording') {
                        mediaRecorder.stop();
                        button.classList.remove('recording');
                        statusDiv.textContent = 'ì²˜ë¦¬ ì¤‘...';
                        button.onclick = () => startSTT(fieldType);
                    }
                };

            } catch (error) {
                console.error('STT ì˜¤ë¥˜:', error);
                alert('ë§ˆì´í¬ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤: ' + error.message);
                statusDiv.textContent = '';
            }
        }

        async function sendSTT(audioBlob, fieldType, mimeType) {
            const statusDiv = document.getElementById(`${fieldType}-status`);

            try {
                let extension = 'webm';
                if (mimeType.includes('mp4')) extension = 'mp4';
                else if (mimeType.includes('mpeg')) extension = 'mp3';
                else if (mimeType.includes('wav')) extension = 'wav';

                const formData = new FormData();
                formData.append('audio_file', audioBlob, `recording.${extension}`);
                formData.append('field_type', fieldType);

                statusDiv.textContent = 'ğŸ”„ ì„œë²„ë¡œ ì „ì†¡ ì¤‘...';

                const response = await fetch(`${API_URL}/api/stt/field`, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error(`STT ìš”ì²­ ì‹¤íŒ¨: ${response.status}`);
                }

                const data = await response.json();
                const resultText = data.parsed_value || data.stt_text;

                if (resultText) {
                    document.getElementById(fieldType).value = resultText;
                    statusDiv.textContent = `âœ“ ì¸ì‹ë¨ (${Math.round(data.confidence * 100)}%)`;
                } else {
                    statusDiv.textContent = 'âœ— ìŒì„±ì„ ì¸ì‹í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤';
                }

                setTimeout(() => statusDiv.textContent = '', 3000);

            } catch (error) {
                console.error('sendSTT ì˜¤ë¥˜:', error);
                statusDiv.textContent = 'âœ— ì¸ì‹ ì‹¤íŒ¨';
                alert('STT ì˜¤ë¥˜: ' + error.message);
            }
        }

        // Story generation
        async function startGeneration() {
            const era = document.getElementById('era').value.trim();
            const place = document.getElementById('place').value.trim();
            const characters = document.getElementById('characters').value.trim();
            const topic = document.getElementById('topic').value.trim();

            if (!era || !place || !characters || !topic) {
                alert('ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/api/runs`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        era_ko: era,
                        place_ko: place,
                        characters_ko: characters,
                        topic_ko: topic,
                        tts_enabled: ttsEnabled
                    })
                });

                if (!response.ok) throw new Error('ìƒì„± ìš”ì²­ ì‹¤íŒ¨');

                const data = await response.json();
                currentRunId = data.run_id;

                // Show first story page (cover)
                showScreen('screen-story-0');
                currentStoryPage = 0;

                // Start monitoring progress
                monitorProgress(currentRunId);

            } catch (error) {
                alert('ì˜¤ë¥˜ ë°œìƒ: ' + error.message);
            }
        }

        function monitorProgress(runId) {
            eventSource = new EventSource(`${API_URL}/api/runs/${runId}/events`);

            eventSource.addEventListener('update', async (event) => {
                const data = JSON.parse(event.data);
                await updatePageDisplay(data);

                if (data.status === 'DONE' || data.status === 'FAILED') {
                    eventSource.close();
                    if (data.status === 'FAILED') {
                        alert('ìƒì„± ì‹¤íŒ¨: ' + (data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                        resetToStart();
                    }
                }
            });
        }

        async function updatePageDisplay(data) {
            // Check each page if it's ready (image + audio)
            for (let page = 0; page <= data.ready_max_page && page < 5; page++) {
                const hasAudio = (data.ready_max_audio_page >= page) || !ttsEnabled;

                if (hasAudio && !pageReadyStatus[page]) {
                    pageReadyStatus[page] = true;
                    await displayPage(page);
                }
            }

            // Check if we can enable next button for all pages
            for (let i = 0; i < 4; i++) {
                if (pageReadyStatus[i + 1]) {
                    const btn = document.getElementById(`next-btn-${i}`);
                    if (btn) btn.disabled = false;
                }
            }
        }

        async function displayPage(pageNum) {
            try {
                const response = await fetch(`${API_URL}/api/runs/${currentRunId}`);
                const data = await response.json();
                const page = data.pages[pageNum];

                // Hide loading, show content
                const contentDiv = document.getElementById(`page-content-${pageNum}`);
                contentDiv.classList.add('ready');

                // Set content
                if (pageNum === 0) {
                    document.getElementById(`title-${pageNum}`).textContent = page.title || '';
                } else {
                    document.getElementById(`summary-${pageNum}`).textContent = page.summary || '';
                }

                if (page.image_url) {
                    document.getElementById(`image-${pageNum}`).src = `${API_URL}${page.image_url}`;
                }

                if (page.audio_url) {
                    const audio = document.getElementById(`audio-${pageNum}`);
                    audio.innerHTML = `<source src="${API_URL}${page.audio_url}" type="audio/wav">`;
                    audio.load();
                }

            } catch (error) {
                console.error('í˜ì´ì§€ í‘œì‹œ ì˜¤ë¥˜:', error);
            }
        }
    </script>
</body>

</html>